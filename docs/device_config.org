*  设备配置流程

#+begin_src ditaa :file device_config.png :cmdline -r -s 0.8

                                                 +----------+
                                                 |          |
                                                 | 配置开始 |
                                                 |   cRED   |
                                                 +-----+----+
                                                       |
                                                       V
                                                 +-----+--------------+
                                                 |                    |
                                                 | 核心板进入配置模式 |
                                                 |                    |
                                                 |   cRED             |
                                                 +-----+--------------+
                                                       |
                                                       |
                                                       V
                                                 +-----+-------------+
                                                 |                   |
                                                 | Imlink 配置 WiFi  |
                                       +-------->+                   |
                                       |         |   cRED            |
                                       |         +-----+-------------+
                                       |               |
                                      否               |
                                       |               V
                                       |         +-----+-----+
                                       |         |           |
                                       +---------+   成功    |
                                                 |           |
                                                 |   cRED    |
                                                 +-----+-----+
                                                       |
                                                       是
                                                       |
                                                       V
                                                 +-----+----------------------------+
                                                 |                                  |
                                                 | 手机发送“检测设备”指令           |
                                                 | 发送:{ "command": "hello"}       |
                                                 | 接收:{ "status":200, "device_id":|
                                                 | "888001xxxxxxxxxxxxxxxxxx",      |
                                                 | "at_mode": 1}                    |
                                                 |                                  |
                                                 |   cRED                           |
                                                 +-----+----------------------------+
                                                       |
                                                       |
                                                       V
                                                 +-----+----------------+
                                                 |                      |
                                                 | at_mode 存在并且为 1 |
                +--------------否----------------+                      +--------------是----------------+
                |                                |   cRED               |                                |
                |                                +----------------------+                                |
                |                                                                                        |
                v                                                                                        v
  +-------------+-----------------------------------+                                     +--------------+----------------------------------+
  |   创建 arduino 设备                             |                                     |   手机发送“设备信息”指令                        |
  |   获取 physics_id 和 access_token               |                                     |   发送：{ "command": "sendDeviceInfo",          |
  |                                                 |                                     |           "value": {"zone": 8, "sv_domain":     |
  |                                                 |                                     |           "iot.intorobot.com", "sv_port": 1883, |
  |                                                 |                                     |           "dw_domain": "www.intorobot.com"}}    |
  |                                                 |                                     |   接收:{"status": 200}                          |
  |        cRED                                     |                                     |             cRED                                |
  +-------------+-----------------------------------+                                     +--------------+----------------------------------+
                |                                                                                        |
                v                                                                                        v
  +-------------+-----------------------------------+                                     +--------------+----------------------------------+
  |   手机发送“设备信息”指令                        |                                     |                                                 |
  |   发送：{ "command": "sendDeviceInfo",          |                                     |                                                 |
  |           "value": {                            |                                     |                                                 |
  |   "device_id": "888000xxxxxxxxxxxxxxxxxx",      |                                     |    核心板连入 mqtt 服务器                       |
  |   "access_token":"xxxxxxxxxxxxxxxxxxxxxxxx",    |                                     |                                                 |
  |   "zone": 8, "sv_domain": "iot.intorobot.com",  |                                     |                                                 |
  |   "sv_port": 1883,                              |                                     |                                                 |
  |   "dw_domain": "www.intorobot.com"}}            |                                     |                                                 |
  |   接收:{"status": 200}                          |                                     |                                                 |
  |             cRED                                |                                     |            cRED                                 |
  +-------------+-----------------------------------+                                     +---------------+---------------------------------+
                |                                                                                         |
                |                                                                                         v
                |                                                                                  +----+--------+
                |                                                                                  |             |
                |                                                                                  |设备是否在线 +----------------+
                |                                                                                  |             |                |
                |                                                                                  |   cRED      |                |
                |                                                                                  +-------+-----+                |
                |                                                                                          |                      |
                |                                                                                          |                      |
                |                                                                                          是                    否
                |                                                                                          |                      |
                |                                                                                          v                      |
                |                                                                                   +------+--------------+       |
                |                                                                                   |                     |       |
                |                                                                                   | 创建 IntoRobot 设备 |       |
                |                                                                                   |   并进行捆绑        |       |
                |                                                                                   |   cRED              |       |
                |                                                                                   +------+--------------+       |
                |                                                                                          |                      v
                |                                +-----------+                                             |                +-----+-----+
                |                                |           |                                             |                |           |
                |                                | 配置成功  |                                             |                | 配置失败  |
                +------------------------------->+           +<--------------------------------------------+                |           |
                                                 |   cRED    |                                                              |   cRED    |
                                                 +-----+-----+                                                              +-----+-----+
                                                       |                                                                          |
                                                       |                                                                          |
                                                       V                                                                          |
                                                 +-----------+                                                                    |
                                                 |           |                                                                    |
                                                 |   结束    |                                                                    |
                                                 |           +<-------------------------------------------------------------------+
                                                 |   cRED    |
                                                 +-----------+
#+end_src
